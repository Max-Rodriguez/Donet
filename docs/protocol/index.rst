.. _protocol:

The Donet Protocol
==================

.. toctree::
    :maxdepth: 1
    :titlesonly:
    :caption: Table of Contents

    encapsulation
    client
    clientagent
    stateserver
    dbserver
    messagedirector
    eventlogger

The Donet network protocol is made up of **two** separate, yet
similar protocols:

    The **Client** and the **Internal** protocols.

**Client** messages are sent only between the clients and the CA.

**Internal** messages are sent only in between services inside the
'trusted zone', that is the cluster network.

Every message type defined has a certain **16-bit** number
identifier. Message type number IDs are organized in ranges, each
range designated to a certain Donet service.

Overview
--------

Client Protocol
^^^^^^^^^^^^^^^

All message types in the client protocol are in the 0-999 range.

- **0 - 99**: Basic messages for maintaining the connection
  with the Client Agent.
- **100 - 199**: Distributed Object generates and field updates.
- **200 - 999**: Client Interest controls.

Internal Protocol
^^^^^^^^^^^^^^^^^

- 1000 - 1999 | Client Agent
    - **1000 - 1099** - Client State and Session controls
    - **1100 - 1199** - Channel Controls
    - **1200 - 1999** - Interest Controls

- 2000 - 2999 | State Server / DBSS
    - **2000 - 2009** - Object Create / Delete
    - **2010 - 2039** - Object Fields
    - **2040 - 2049** - Object Location
    - **2050 - 2059** - Object Designated AI
    - **2060 - 2099** - Object Ownership
    - **2100 - 2199** - Zone Controls
    - **2200 - 2229** - DBSS Object Activation
    - **2230 - 2239** - Object Data on Disk

- 3000 - 3999 | Database Server
    - **3000 - 3009** - Object Create
    - **3010 - 3019** - Object Get Fields
    - **3020 - 3029** - Object Set Fields
    - **3030 - 3039** - Object Delete Fields

- 9000 - 9999 | Message Director
    - **9000 - 9009** - Channels and Channel Ranges
    - **9010 - 9019** - Post Removes

Protocol Reference
------------------

Message Director | Control Messages
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+----------------------------------+------+---------------------------------+
| Message                          | ID   | Parameters                      |
+==================================+======+=================================+
| :ref:`ADD_CHANNEL <9000>`        | 9000 | **uint64** channel              |
+----------------------------------+------+---------------------------------+
| :ref:`REMOVE_CHANNEL <9001>`     | 9001 | **uint64** channel              |
+----------------------------------+------+---------------------------------+
| :ref:`ADD_RANGE <9002>`          | 9002 | **uint64** low, **uint64** high |
+----------------------------------+------+---------------------------------+
| :ref:`REMOVE_RANGE <9003>`       | 9003 | **uint64** low, **uint64** high |
+----------------------------------+------+---------------------------------+
| :ref:`ADD_POST_REMOVE <9010>`    | 9010 | **blob** datagram               |
+----------------------------------+------+---------------------------------+
| :ref:`CLEAR_POST_REMOVES <9011>` | 9011 |                                 |
+----------------------------------+------+---------------------------------+
| :ref:`SET_CON_NAME <9012>`       | 9012 | **string** name                 |
+----------------------------------+------+---------------------------------+
| :ref:`SET_CON_URL <9013>`        | 9013 | **string** url                  |
+----------------------------------+------+---------------------------------+
| :ref:`LOG_MESSAGE <9014>`        | 9014 | **blob** message                |
+----------------------------------+------+---------------------------------+

Client Messages
^^^^^^^^^^^^^^^

+------------------------------------------------+------+-------------------------------+
| Message                                        | ID   | Parameters                    |
+================================================+======+===============================+
| :ref:`HELLO <1>`                               | 1    | **uint32** dc_hash,           |
|                                                |      | **string** version            |
+------------------------------------------------+------+-------------------------------+
| :ref:`HELLO_RESP <2>`                          | 2    |                               |
+------------------------------------------------+------+-------------------------------+
| :ref:`DISCONNECT <3>`                          | 3    |                               |
+------------------------------------------------+------+-------------------------------+
| :ref:`EJECT <4>`                               | 4    | **uint16** error_code,        |
|                                                |      | **string** reason             |
+------------------------------------------------+------+-------------------------------+
| :ref:`HEARTBEAT <5>`                           | 5    |                               |
+------------------------------------------------+------+-------------------------------+
| :ref:`ENTER_OBJECT_REQUIRED <142>`             | 142  | **uint32** do_id,             |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id,           |
|                                                |      | **uint16** dclass_id,         |
|                                                |      | ``<REQUIRED>``                |
+------------------------------------------------+------+-------------------------------+
| :ref:`ENTER_OBJECT_REQUIRED_OTHER <143>`       | 143  | **uint32** do_id,             |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id,           |
|                                                |      | **uint16** dclass_id,         |
|                                                |      | ``<REQUIRED>``, ``<OTHER>``   |
+------------------------------------------------+------+-------------------------------+
| :ref:`ENTER_OBJECT_REQUIRED_OWNER <172>`       | 172  | **uint32** do_id,             |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id,           |
|                                                |      | **uint16** dclass_id,         |
|                                                |      | ``<REQUIRED>``                |
+------------------------------------------------+------+-------------------------------+
| :ref:`ENTER_OBJECT_REQUIRED_OTHER_OWNER <173>` | 173  | **uint32** do_id,             |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id,           |
|                                                |      | **uint16** dclass_id,         |
|                                                |      | ``<REQUIRED>``, ``<OTHER>``   |
+------------------------------------------------+------+-------------------------------+
| :ref:`OBJECT_SET_FIELD <120>`                  | 120  | **uint32** do_id,             |
|                                                |      | **uint16** field_id,          |
|                                                |      | ``<VALUE>``                   |
+------------------------------------------------+------+-------------------------------+
| :ref:`OBJECT_SET_FIELDS <121>`                 | 121  | **uint32** do_id,             |
|                                                |      | **uint16** n_fields,          |
|                                                |      | [**uint16** field_id,         |
|                                                |      | ``<VALUE>``] * n_fields       |
+------------------------------------------------+------+-------------------------------+
| :ref:`OBJECT_LEAVING <132>`                    | 132  | **uint32** do_id              |
+------------------------------------------------+------+-------------------------------+
| :ref:`OBJECT_LOCATION <140>`                   | 140  | **uint32** do_id,             |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id            |
+------------------------------------------------+------+-------------------------------+
| :ref:`ADD_INTEREST <200>`                      | 200  | **uint32** context,           |
|                                                |      | **uint16** interest_id,       |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint32** zone_id            |
+------------------------------------------------+------+-------------------------------+
| :ref:`ADD_INTEREST_MULTIPLE <201>`             | 201  | **uint32** context,           |
|                                                |      | **uint16** interest_id,       |
|                                                |      | **uint32** parent_id,         |
|                                                |      | **uint16** n_zones,           |
|                                                |      | [**uint32** zone_id] * n_zones|
+------------------------------------------------+------+-------------------------------+
| :ref:`REMOVE_INTEREST <203>`                   | 203  | **uint32** context,           |
|                                                |      | **uint16** interest_id        |
+------------------------------------------------+------+-------------------------------+
| :ref:`DONE_INTEREST_RESP <204>`                | 204  | **uint32** context,           |
|                                                |      | **uint16** interest_id        |
+------------------------------------------------+------+-------------------------------+

Client Agent Messages
^^^^^^^^^^^^^^^^^^^^^

+----------------------------------------+------+---------------------------------------+
| Message                                | ID   | Parameters                            |
+========================================+======+=======================================+
| :ref:`SET_STATE <1000>`                | 1000 | **uint16** ca_state                   |
+----------------------------------------+------+---------------------------------------+
| :ref:`SET_CLIENT_ID <1001>`            | 1001 | **uint64** channel                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`SEND_DATAGRAM <1002>`            | 1002 | **blob** datagram                     |
+----------------------------------------+------+---------------------------------------+
| :ref:`EJECT <1004>`                    | 1004 | **uint16** error_code,                |
|                                        |      | **string** reason                     |
+----------------------------------------+------+---------------------------------------+
| :ref:`DROP <1005>`                     | 1005 |                                       |
+----------------------------------------+------+---------------------------------------+
| :ref:`GET_NETWORK_ADDRESS <1006>`      | 1006 | **uint32** context                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`GET_NETWORK_ADDRESS_RESP <1007>` | 1007 | **uint32** context,                   |
|                                        |      | **string** remote_ip,                 |
|                                        |      | **uint16** remote_port,               |
|                                        |      | **string** local_ip,                  |
|                                        |      | **uint16** local_port                 |
+----------------------------------------+------+---------------------------------------+
| :ref:`DECLARE_OBJECT <1010>`           | 1010 | **uint32** do_id, **uint16** dclass_id|
+----------------------------------------+------+---------------------------------------+
| :ref:`UNDECLARE_OBJECT <1011>`         | 1011 | **uint32** do_id                      |
+----------------------------------------+------+---------------------------------------+
| :ref:`ADD_SESSION_OBJECT <1012>`       | 1012 | **uint32** do_id                      |
+----------------------------------------+------+---------------------------------------+
| :ref:`REMOVE_SESSION_OBJECT <1013>`    | 1013 | **uint32** do_id                      |
+----------------------------------------+------+---------------------------------------+
| :ref:`SET_FIELDS_SENDABLE <1014>`      | 1014 | **uint32** do_id,                     |
|                                        |      | [**uint16** field_id], [...]          |
+----------------------------------------+------+---------------------------------------+
| :ref:`GET_TLVS <1015>`                 | 1015 | **uint32** context                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`GET_TLVS_RESP <1016>`            | 1016 | **uint32** context, **blob** tlvs     |
+----------------------------------------+------+---------------------------------------+
| :ref:`OPEN_CHANNEL <1100>`             | 1100 | **uint64** channel                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`CLOSE_CHANNEL <1101>`            | 1101 | **uint64** channel                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`ADD_POST_REMOVE <1110>`          | 1110 | **blob** datagram                     |
+----------------------------------------+------+---------------------------------------+
| :ref:`CLEAR_POST_REMOVES <1111>`       | 1111 |                                       |
+----------------------------------------+------+---------------------------------------+
| :ref:`ADD_INTEREST <1200>`             | 1200 | **uint16** interest_id,               |
|                                        |      | **uint32** parent_id,                 |
|                                        |      | **uint32** zone_id                    |
+----------------------------------------+------+---------------------------------------+
| :ref:`ADD_INTEREST_MULTIPLE <1201>`    | 1201 | **uint16** interest_id,               |
|                                        |      | **uint32** parent_id,                 |
|                                        |      | **uint16** n_zones,                   |
|                                        |      | [**uint32** zone_id] * n_zones        |
+----------------------------------------+------+---------------------------------------+
| :ref:`REMOVE_INTEREST <1203>`          | 1203 | **uint16** interest_id                |
+----------------------------------------+------+---------------------------------------+

State Server Messages
^^^^^^^^^^^^^^^^^^^^^

+-------------------------------------------------+------+------------------------------+
| Message                                         | ID   | Parameters                   |
+=================================================+======+==============================+
| :ref:`CREATE_OBJECT_WITH_REQUIRED <2000>`       | 2000 | **uint32** do_id,            |
|                                                 |      | **uint32** parent_id,        |
|                                                 |      | **uint32** zone_id,          |
|                                                 |      | **uint16** dclass_id,        |
|                                                 |      | ``<REQUIRED>``               |
+-------------------------------------------------+------+------------------------------+
| :ref:`CREATE_OBJECT_WITH_REQUIRED_OTHER <2001>` | 2001 | **uint32** do_id,            |
|                                                 |      | **uint32** parent_id,        |
|                                                 |      | **uint32** zone_id,          |
|                                                 |      | **uint16** dclass_id,        |
|                                                 |      | ``<REQUIRED>``, ``<OTHER>``  |
+-------------------------------------------------+------+------------------------------+
| :ref:`DELETE_AI_OBJECTS <2009>`                 | 2009 | **uint64** ai_channel        |
+-------------------------------------------------+------+------------------------------+

State Server | Distributed Object Accessor Messages
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+----------------------------------------+------+---------------------------------------+
| Message                                | ID   | Parameters                            |
+========================================+======+=======================================+
| :ref:`OBJECT_GET_FIELD <2010>`         | 2010 | **uint32** context, **uint32** do_id, |
|                                        |      | **uint16** field_id                   |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_GET_FIELD_RESP <2011>`    | 2011 | **uint32** context, **uint8** success,|
|                                        |      | [**uint16** field_id, ``<VALUE>``]    |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_GET_FIELDS <2012>`        | 2012 | **uint32** context, **uint32** do_id, |
|                                        |      | **uint16** n_fields,                  |
|                                        |      | [**uint16** field_id] * n_fields      |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_GET_FIELDS_RESP <2013>`   | 2013 | **uint32** context, **uint8** success,|
|                                        |      | **uint16** n_fields,                  |
|                                        |      | [**uint16** field_id, ``<VALUE>``]    |
|                                        |      | * n_fields                            |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_GET_ALL <2014>`           | 2014 | **uint32** context, **uint32** do_id  |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_GET_ALL_RESP <2015>`      | 2015 | **uint32** context, **uint32** do_id, |
|                                        |      | **uint32** parent_id,                 |
|                                        |      | **uint32** zone_id,                   |
|                                        |      | **uint16** dclass_id,                 |
|                                        |      | ``<REQUIRED>``, ``<OTHER>``           |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_SET_FIELD <2020>`         | 2020 | **uint32** do_id, **uint16** field_id,|
|                                        |      | ``<VALUE>``                           |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_SET_FIELDS <2021>`        | 2021 | **uint32** do_id, **uint16** n_fields,|
|                                        |      | [**uint16** field_id, ``<VALUE>``]    |
|                                        |      | * n_fields                            |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_DELETE_FIELD_RAM <2030>`  | 2030 | **uint32** do_id, **uint16** field_id |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_DELETE_FIELDS_RAM <2031>` | 2031 | **uint32** do_id, **uint16** n_fields,|
|                                        |      | [**uint16** field_id] * n_fields      |
+----------------------------------------+------+---------------------------------------+
| :ref:`OBJECT_DELETE_RAM <2032>`        | 2032 | **uint32** do_id                      |
+----------------------------------------+------+---------------------------------------+

State Server | Distributed Object Visibility Messages
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+---------------------------------------------------------+------+----------------------+
| Message                                                 | ID   | Parameters           |
+=========================================================+======+======================+
| :ref:`OBJECT_SET_LOCATION <2040>`                       | 2040 | **uint32** parent_id,|
|                                                         |      | **uint32** zone_id   |
+---------------------------------------------------------+------+----------------------+
| :ref:`OBJECT_CHANGING_LOCATION <2041>`                  | 2041 | **uint32** do_id,    |
|                                                         |      | **uint32** parent,   |
|                                                         |      | **uint32** zone,     |
|                                                         |      | **uint32** old_parent|
|                                                         |      | , **uint32** old_zone|
+---------------------------------------------------------+------+----------------------+
| :ref:`OBJECT_ENTER_LOCATION_WITH_REQUIRED <2042>`       | 2042 | **uint32** do_id,    |
|                                                         |      | **uint32** parent_id,|
|                                                         |      | **uint32** zone_id,  |
|                                                         |      | **uint16** dclass_id,|
|                                                         |      | ``<REQUIRED>``       |
+---------------------------------------------------------+------+----------------------+
| :ref:`OBJECT_ENTER_LOCATION_WITH_REQUIRED_OTHER <2043>` | 2043 | **uint32** do_id,    |
|                                                         |      | **uint32** parent_id,|
|                                                         |      | **uint32** zone_id,  |
|                                                         |      | **uint16** dclass_id,|
|                                                         |      | ``<REQUIRED>``,      |
|                                                         |      | ``<OTHER>``          |
+---------------------------------------------------------+------+----------------------+
| :ref:`OBJECT_GET_LOCATION <2044>`                       | 2044 | **uint32** context   |
+---------------------------------------------------------+------+----------------------+

State Server | Parent Object Methods
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

DBSS Object Messages
^^^^^^^^^^^^^^^^^^^^

Database Object Messages
^^^^^^^^^^^^^^^^^^^^^^^^

